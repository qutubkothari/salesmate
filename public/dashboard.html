<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SAK Salesmate Dashboard</title>
    <!-- Updated: Follow-ups tab added - v20251112 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; border: 1px solid rgba(255,255,255,0.1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); border-color: rgba(255,255,255,0.2); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); }
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }
        .animate-pulse-soft { animation: pulseSoft 2s infinite; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulseSoft { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .search-input { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.03) 100%); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.06); }
        .tab-active { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2); }
        .delete-btn { transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.05); }
        .loading-spinner { border: 3px solid rgba(255,255,255,0.25); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .conversation-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); }
        .config-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.9) 100%); }
        .success-alert { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .error-alert { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        /* Hide scrollbar while maintaining scroll functionality */
        .overflow-x-auto::-webkit-scrollbar { display: none; }
        .overflow-x-auto { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Sidebar Styles */
        .sidebar { 
            width: 280px; 
            transition: width 0.3s ease, transform 0.3s ease; 
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            z-index: 50;
            overflow-y: auto;
        }
        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: transparent; }
        .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.18); border-radius: 9999px; }
        .sidebar { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.18) transparent; }
        .sidebar.collapsed { width: 80px; }
        .sidebar-header { transition: padding 0.3s ease; }
        .sidebar.collapsed .sidebar-header { padding: 16px 12px; }
        .sidebar.collapsed .sidebar-header .flex { justify-content: center; }
        .sidebar.collapsed .sidebar-text { opacity: 0; width: 0; overflow: hidden; }
        .sidebar-item {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 10px 14px;
            border-radius: 12px;
            margin: 4px 12px;
            display: flex;
            align-items: center;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            font-weight: 500;
        }
        .sidebar.collapsed .sidebar-item { justify-content: center; padding: 12px; margin: 4px 10px; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-item.active { 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        .sidebar-item i { width: 24px; min-width: 24px; text-align: center; font-size: 18px; }
        .sidebar-item span {
            margin-left: 16px;
            white-space: nowrap;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .sidebar.collapsed .sidebar-item span { opacity: 0; width: 0; overflow: hidden; }
        .main-content { 
            margin-left: 280px; 
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .main-content.expanded { margin-left: 80px; }
        .sidebar-toggle {
            position: fixed;
            top: 24px;
            left: calc(280px - 18px);
            z-index: 51;
            transition: left 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            background: rgba(255,255,255,0.14);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .sidebar-toggle:hover { background: rgba(255,255,255,0.22); }
        .sidebar-toggle.collapsed { left: calc(80px - 18px); }
        #visitBranchFilter option,
        #visitSalesmanFilter option {
            color: #111;
            background: #fff;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .sidebar-toggle { left: 16px; }
        }
    </style>
</head>
<body class="min-h-screen gradient-bg">
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
            <div class="text-center glass-effect p-8 rounded-2xl">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h2 class="text-white text-xl font-semibold mb-2">Loading Dashboard</h2>
                <p class="text-white/70">Please wait while we fetch your data...</p>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Sidebar Navigation -->
            <aside id="sidebar" class="sidebar glass-effect">
                <div class="sidebar-header p-6 border-b border-white/20">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <img src="/assets/logo.png" alt="Logo" class="w-6 h-6" />
                        </div>
                        <div class="sidebar-text">
                            <h2 class="text-white font-bold text-lg">Salesmate</h2>
                            <p class="text-white/60 text-xs">Dashboard</p>
                        </div>
                    </div>
                </div>

                <nav class="py-4">
                    <!-- Dashboard / Overview - Always visible -->
                    <div class="sidebar-item active" onclick="switchTab('overview')" data-tab="overview">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </div>

                    <!-- Hidden tabs - will be activated based on subscription modules -->
                    <div class="sidebar-item" onclick="switchTab('conversations')" data-tab="conversations" style="display: none;">
                        <i class="fas fa-comments"></i>
                        <span>Conversations</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('orders')" data-tab="orders" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Orders</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('followups')" data-tab="followups">
                        <i class="fas fa-clock"></i>
                        <span>Follow-ups</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('leads')" data-tab="leads">
                        <i class="fas fa-user-tag"></i>
                        <span>Leads</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('email')" data-tab="email">
                        <i class="fas fa-envelope"></i>
                        <span>Email</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('interactive')" data-tab="interactive">
                        <i class="fas fa-hand-pointer"></i>
                        <span>Interactive</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('triage')" data-tab="triage">
                        <i class="fas fa-life-ring"></i>
                        <span>Triage</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('products')" data-tab="products">
                        <i class="fas fa-box"></i>
                        <span>Products</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('documents')" data-tab="documents">
                        <i class="fas fa-file-alt"></i>
                        <span>Documents</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('customers')" data-tab="customers">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </div>

                    <!-- FSM Section -->
                    <div class="px-4 py-2 mt-4">
                        <p class="text-white/40 text-xs font-semibold uppercase tracking-wider">Field Sales</p>
                    </div>

                    <div class="sidebar-item" onclick="switchTab('visits')" data-tab="visits">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Visits</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('salesmen')" data-tab="salesmen">
                        <i class="fas fa-user-tie"></i>
                        <span>Sales Team</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('targets')" data-tab="targets">
                        <i class="fas fa-bullseye"></i>
                        <span>Targets</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('branches')" data-tab="branches">
                        <i class="fas fa-code-branch"></i>
                        <span>Branches</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('reports')" data-tab="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </div>

                    <div class="px-4 py-2 mt-4">
                        <p class="text-white/40 text-xs font-semibold uppercase tracking-wider">System</p>
                    </div>

                    <div class="sidebar-item" onclick="switchTab('settings')" data-tab="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('analytics')" data-tab="analytics">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('reports')" data-tab="reports">
                        <i class="fas fa-file-alt"></i>
                        <span>Reports</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('activity-feed')" data-tab="activity-feed">
                        <i class="fas fa-list"></i>
                        <span>Activity Feed</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('audit-logs')" data-tab="audit-logs">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Audit Logs</span>
                    </div>
                    <div class="sidebar-item" onclick="switchTab('broadcast')" data-tab="broadcast">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>Broadcast</span>
                    </div>
                </nav>
            </aside>

            <!-- Sidebar Toggle Button -->
            <button id="sidebarToggle" onclick="toggleSidebar()" class="sidebar-toggle text-white transition-all" aria-label="Toggle sidebar" title="Toggle sidebar">
                <i id="sidebarToggleIcon" class="fas fa-angles-left" style="font-size: 14px;"></i>
            </button>

            <!-- Main Content Area -->
            <div id="mainContent" class="main-content">
                <!-- Header -->
                <header class="glass-effect border-b border-white/20 sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <h1 class="text-2xl font-bold text-white" id="businessName">Sales Dashboard</h1>
                                    <p class="text-white/70 text-sm">WhatsApp AI Assistant</p>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <input type="text" id="globalSearch" placeholder="Search conversations, orders..." class="search-input pl-10 pr-4 py-2 rounded-xl border-0 w-64 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                </div>

                                <button onclick="toggleNotifications()" class="glass-effect p-3 rounded-xl text-white hover:bg-white/20 transition-colors relative">
                                    <i class="fas fa-bell"></i>
                                    <span id="notifBadge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-xs flex items-center justify-center">0</span>
                                </button>

                                <button onclick="handleLogout()" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Notifications Panel -->
                <div id="notificationsPanel" class="hidden fixed top-20 right-6 w-96 max-h-[600px] rounded-2xl shadow-2xl z-40 overflow-hidden bg-slate-900/90 backdrop-blur-xl border border-white/10">
                    <div class="p-4 border-b border-white/10 flex items-center justify-between">
                        <h3 class="text-white font-semibold text-lg"><i class="fas fa-bell mr-2"></i>Notifications</h3>
                        <button onclick="clearAllNotifications()" class="text-white/70 hover:text-white text-sm">Clear All</button>
                    </div>
                    <div id="notificationsList" class="overflow-y-auto max-h-[500px]">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>

                <!-- Stats Overview - Only visible on Dashboard/Overview tab -->
                <section id="statsSection" class="max-w-7xl mx-auto px-6 py-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8" id="statsGrid">
                        <!-- Stats will be dynamically loaded -->
                    </div>
                </section>

                <!-- Tab Content -->
                <main class="max-w-7xl mx-auto px-6 pb-8">
                    <!-- Main dynamic content area -->
                    <div id="tabContent" class="animate-fade-in">
                        <!-- Content loaded dynamically by JavaScript -->
                    </div>

                <!-- ========== FSM TABS ========== -->
                
                <!-- Visits Tab -->
                <div id="visitsTab" class="hidden">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <!-- Header with filters and role indicator -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                            <div>
                                <h2 class="text-white text-2xl font-bold">Field Visits</h2>
                                <p id="fsmRoleIndicator" class="text-white/60 text-sm mt-1"></p>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <select id="visitBranchFilter" onchange="loadVisits()" class="px-4 py-2 rounded-lg bg-white/10 text-white border border-white/20">
                                    <option value="">All Branches</option>
                                </select>
                                <select id="visitSalesmanFilter" onchange="loadVisits()" class="px-4 py-2 rounded-lg bg-white/10 text-white border border-white/20">
                                    <option value="">All Salesmen</option>
                                </select>
                                <input type="date" id="visitDateFrom" onchange="loadVisits()" class="px-4 py-2 rounded-lg bg-white/10 text-white border border-white/20" />
                                <input type="date" id="visitDateTo" onchange="loadVisits()" class="px-4 py-2 rounded-lg bg-white/10 text-white border border-white/20" />
                                <button onclick="exportVisitsExcel()" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg text-white">
                                    <i class="fas fa-download mr-2"></i>Export Excel
                                </button>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Total Visits</p>
                                        <p class="text-white text-2xl font-bold" id="totalVisitsCount">0</p>
                                    </div>
                                    <i class="fas fa-map-marker-alt text-blue-400 text-3xl"></i>
                                </div>
                            </div>
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Completed Today</p>
                                        <p class="text-white text-2xl font-bold" id="todayVisitsCount">0</p>
                                    </div>
                                    <i class="fas fa-check-circle text-green-400 text-3xl"></i>
                                </div>
                            </div>
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Active Salesmen</p>
                                        <p class="text-white text-2xl font-bold" id="activeSalesmenCount">0</p>
                                    </div>
                                    <i class="fas fa-user-tie text-purple-400 text-3xl"></i>
                                </div>
                            </div>
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Avg. Visit Duration</p>
                                        <p class="text-white text-2xl font-bold" id="avgVisitDuration">0</p>
                                        <p class="text-white/60 text-xs">minutes</p>
                                    </div>
                                    <i class="fas fa-clock text-yellow-400 text-3xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Table Controls -->
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                            <div class="flex items-center gap-2 text-white/70 text-sm">
                                <span>Rows:</span>
                                <select id="visitsPageSize" class="px-2 py-1 rounded-lg bg-white/10 text-white border border-white/20">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                                <div id="visitsPageInfo" class="ml-2 text-white/60"></div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="visitsPrevPage" class="px-3 py-1.5 rounded-lg bg-white/10 text-white hover:bg-white/20">Prev</button>
                                <button id="visitsNextPage" class="px-3 py-1.5 rounded-lg bg-white/10 text-white hover:bg-white/20">Next</button>
                                <div class="relative">
                                    <button id="visitsColumnToggle" class="px-3 py-1.5 rounded-lg bg-white/10 text-white hover:bg-white/20">Columns</button>
                                    <div id="visitsColumnMenu" class="hidden absolute right-0 mt-2 w-52 rounded-lg bg-slate-900/90 backdrop-blur border border-white/10 p-3 text-white text-sm z-10">
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="date" checked /> Date</label>
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="customer" checked /> Customer</label>
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="salesman" checked /> Salesman</label>
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="branch" checked /> Branch</label>
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="type" checked /> Type</label>
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="duration" checked /> Duration</label>
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="potential" checked /> Potential</label>
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="status" checked /> Status</label>
                                        <label class="flex items-center gap-2 py-1"><input type="checkbox" data-col="actions" checked /> Actions</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Visits Table -->
                        <div class="glass-effect rounded-xl p-6 overflow-x-auto">
                            <table class="w-full" id="visitsTable">
                                <thead>
                                    <tr class="text-white/60 text-sm border-b border-white/10">
                                        <th class="text-left py-3 px-4 cursor-pointer" data-sort="visit_date" data-col="date">Date</th>
                                        <th class="text-left py-3 px-4 cursor-pointer" data-sort="customer_name" data-col="customer">Customer</th>
                                        <th class="text-left py-3 px-4 cursor-pointer" data-sort="salesman_name" data-col="salesman">Salesman</th>
                                        <th class="text-left py-3 px-4 cursor-pointer" data-sort="plant_name" data-col="branch">Branch</th>
                                        <th class="text-left py-3 px-4 cursor-pointer" data-sort="visit_type" data-col="type">Type</th>
                                        <th class="text-left py-3 px-4 cursor-pointer" data-sort="duration_minutes" data-col="duration">Duration</th>
                                        <th class="text-left py-3 px-4 cursor-pointer" data-sort="potential" data-col="potential">Potential</th>
                                        <th class="text-left py-3 px-4 cursor-pointer" data-sort="status" data-col="status">Status</th>
                                        <th class="text-left py-3 px-4" data-col="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="visitsTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center py-8 text-white/60">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading visits...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Salesmen Tab -->
                <div id="salesmenTab" class="hidden">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-white text-2xl font-bold">Sales Team</h2>
                            <button onclick="showAddSalesmanModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-white">
                                <i class="fas fa-plus mr-2"></i>Add Salesman
                            </button>
                        </div>

                        <!-- Salesmen Table -->
                        <div class="glass-effect rounded-xl p-6 overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-white/60 text-sm border-b border-white/10">
                                        <th class="text-left py-3 px-4">Name</th>
                                        <th class="text-left py-3 px-4">Phone</th>
                                        <th class="text-left py-3 px-4">Branch</th>
                                        <th class="text-left py-3 px-4">Visits (Month)</th>
                                        <th class="text-left py-3 px-4">Target Progress</th>
                                        <th class="text-left py-3 px-4">Status</th>
                                        <th class="text-left py-3 px-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="salesmenTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-white/60">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading salesmen...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Targets Tab -->
                <div id="targetsTab" class="hidden">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-white text-2xl font-bold">Sales Targets</h2>
                            <button onclick="showAddTargetModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-white">
                                <i class="fas fa-plus mr-2"></i>Add Target
                            </button>
                        </div>

                        <!-- Targets Summary -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Total Targets</p>
                                        <p class="text-white text-2xl font-bold" id="totalTargetsCount">0</p>
                                    </div>
                                    <i class="fas fa-bullseye text-blue-400 text-3xl"></i>
                                </div>
                            </div>
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Achieved Targets</p>
                                        <p class="text-white text-2xl font-bold" id="achievedTargetsCount">0</p>
                                    </div>
                                    <i class="fas fa-check text-green-400 text-3xl"></i>
                                </div>
                            </div>
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Pending Targets</p>
                                        <p class="text-white text-2xl font-bold" id="pendingTargetsCount">0</p>
                                    </div>
                                    <i class="fas fa-chart-line text-purple-400 text-3xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Targets Table -->
                        <div class="glass-effect rounded-xl p-6 overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-white/60 text-sm border-b border-white/10">
                                        <th class="text-left py-3 px-4">Salesman</th>
                                        <th class="text-left py-3 px-4">Month</th>
                                        <th class="text-left py-3 px-4">Visit Target</th>
                                        <th class="text-left py-3 px-4">Achieved Visits</th>
                                        <th class="text-left py-3 px-4">Order Target</th>
                                        <th class="text-left py-3 px-4">Achieved Orders</th>
                                        <th class="text-left py-3 px-4">Revenue Target</th>
                                        <th class="text-left py-3 px-4">Achieved Revenue</th>
                                        <th class="text-left py-3 px-4">Progress</th>
                                        <th class="text-left py-3 px-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="targetsTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center py-8 text-white/60">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading targets...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Branches Tab -->
                <div id="branchesTab" class="hidden">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-white text-2xl font-bold">Branches & Plants</h2>
                            <button onclick="showAddBranchModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-white">
                                <i class="fas fa-plus mr-2"></i>Add Branch
                            </button>
                        </div>

                        <!-- Branches Table -->
                        <div class="glass-effect rounded-xl p-6 overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="text-white/60 text-sm border-b border-white/10">
                                        <th class="text-left py-3 px-4">Branch Name</th>
                                        <th class="text-left py-3 px-4">Location</th>
                                        <th class="text-left py-3 px-4">Contact</th>
                                        <th class="text-left py-3 px-4">Assigned Salesmen</th>
                                        <th class="text-left py-3 px-4">Status</th>
                                        <th class="text-left py-3 px-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="branchesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-white/60">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading branches...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- FSM Reports Tab -->
                <div id="reportsTab" class="hidden">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-white text-2xl font-bold">FSM Reports & Analytics</h2>
                            <div class="flex gap-3">
                                <input type="month" id="reportMonth" onchange="loadFSMReports()" class="px-4 py-2 rounded-lg bg-white/10 text-white border border-white/20" />
                                <button onclick="loadFSMReports()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-white">
                                    <i class="fas fa-sync mr-2"></i>Refresh
                                </button>
                                <button onclick="exportFSMReport()" class="px-4 py-2 bg-green-500 hover:bg-green-600 rounded-lg text-white">
                                    <i class="fas fa-download mr-2"></i>Export PDF
                                </button>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Total Visits</p>
                                        <p class="text-white text-3xl font-bold" id="reportTotalVisits">0</p>
                                    </div>
                                    <i class="fas fa-map-marked-alt text-blue-400 text-4xl"></i>
                                </div>
                            </div>
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Avg. Duration</p>
                                        <p class="text-white text-3xl font-bold" id="reportAvgDuration">0</p>
                                        <p class="text-white/40 text-xs">minutes</p>
                                    </div>
                                    <i class="fas fa-clock text-yellow-400 text-4xl"></i>
                                </div>
                            </div>
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Hit Ratio</p>
                                        <p class="text-white text-3xl font-bold" id="reportHitRatio">0%</p>
                                    </div>
                                    <i class="fas fa-bullseye text-green-400 text-4xl"></i>
                                </div>
                            </div>
                            <div class="stat-card p-4 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-white/60 text-sm">Target Achievement</p>
                                        <p class="text-white text-3xl font-bold" id="reportTargetAchievement">0%</p>
                                    </div>
                                    <i class="fas fa-chart-line text-purple-400 text-4xl"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- Visit Trend -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-white text-lg font-semibold mb-4">
                                    <i class="fas fa-chart-area mr-2 text-blue-400"></i>Visit Trend
                                </h3>
                                <canvas id="visitTrendChart" height="250"></canvas>
                            </div>

                            <!-- Visit Type Distribution -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-white text-lg font-semibold mb-4">
                                    <i class="fas fa-chart-pie mr-2 text-green-400"></i>Visit Types
                                </h3>
                                <canvas id="visitTypeChart" height="250"></canvas>
                            </div>
                        </div>

                        <!-- Salesman Performance Table -->
                        <div class="glass-effect rounded-xl p-6 mb-6">
                            <h3 class="text-white text-lg font-semibold mb-4">
                                <i class="fas fa-trophy mr-2 text-yellow-400"></i>Salesman Performance Leaderboard
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="text-white/60 text-sm border-b border-white/10">
                                            <th class="text-left py-3 px-4">Rank</th>
                                            <th class="text-left py-3 px-4">Salesman</th>
                                            <th class="text-left py-3 px-4">Visits</th>
                                            <th class="text-left py-3 px-4">Target</th>
                                            <th class="text-left py-3 px-4">Achievement</th>
                                            <th class="text-left py-3 px-4">Avg. Duration</th>
                                            <th class="text-left py-3 px-4">High Potential</th>
                                            <th class="text-left py-3 px-4">Performance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesmanPerformanceBody">
                                        <tr>
                                            <td colspan="8" class="text-center py-8 text-white/60">
                                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading performance data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Branch Performance -->
                        <div class="glass-effect rounded-xl p-6">
                            <h3 class="text-white text-lg font-semibold mb-4">
                                <i class="fas fa-building mr-2 text-teal-400"></i>Branch-wise Performance
                            </h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="text-white/60 text-sm border-b border-white/10">
                                            <th class="text-left py-3 px-4">Branch</th>
                                            <th class="text-left py-3 px-4">Salesmen</th>
                                            <th class="text-left py-3 px-4">Total Visits</th>
                                            <th class="text-left py-3 px-4">Avg. Visits/Salesman</th>
                                            <th class="text-left py-3 px-4">High Potential %</th>
                                            <th class="text-left py-3 px-4">Branch Score</th>
                                        </tr>
                                    </thead>
                                    <tbody id="branchPerformanceBody">
                                        <tr>
                                            <td colspan="6" class="text-center py-8 text-white/60">
                                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading branch data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FIXED: Customers Tab (separate from tabContent) -->
                <div id="customersTab" class="hidden">
                    <div class="mb-6 flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-white">Customers</h2>
                        <button onclick="switchTab('conversations')" class="glass-effect px-4 py-2 rounded-xl text-white hover:bg-white/20 transition-colors">
                            <i class="fas fa-comments mr-2"></i>Recent Conversations
                        </button>
                    </div>
                    <div class="mb-4 flex flex-col md:flex-row md:items-end gap-4">
                        <input id="customerSearchInput" type="text" placeholder="Search by phone, name..." class="search-input px-4 py-2 rounded-xl border w-full md:w-64" />
                        <input id="customerMinSpent" type="number" placeholder="Min Spent" class="search-input px-4 py-2 rounded-xl border w-full md:w-32" />
                        <input id="customerMaxSpent" type="number" placeholder="Max Spent" class="search-input px-4 py-2 rounded-xl border w-full md:w-32" />
                        <input id="customerMinOrderDate" type="date" class="search-input px-4 py-2 rounded-xl border w-full md:w-40" />
                        <input id="customerMaxOrderDate" type="date" class="search-input px-4 py-2 rounded-xl border w-full md:w-40" />
                        <button id="customerSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700">Search</button>
                    </div>
                    <div class="overflow-x-auto rounded-xl bg-white/80 shadow-lg">
                        <table class="min-w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 font-semibold">Name</th>
                                    <th class="px-4 py-2 font-semibold">Phone</th>
                                    <th class="px-4 py-2 font-semibold">Last Order</th>
                                    <th class="px-4 py-2 font-semibold">Total Spent</th>
                                    <th class="px-4 py-2 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customerListBody">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading customers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Website Content Tab -->
                <div id="websiteTab" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Stats Cards -->
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Crawled URLs</h3>
                                <i class="fas fa-link text-blue-400"></i>
                            </div>
                            <p id="websiteUrlCount" class="text-3xl font-bold text-white">0</p>
                        </div>
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Content Chunks</h3>
                                <i class="fas fa-cube text-purple-400"></i>
                            </div>
                            <p id="websiteChunkCount" class="text-3xl font-bold text-white">0</p>
                        </div>
                        <div class="stat-card p-6 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-white/80 text-sm">Last Crawl</h3>
                                <i class="fas fa-clock text-green-400"></i>
                            </div>
                            <p id="websiteLastCrawl" class="text-lg font-medium text-white">Never</p>
                        </div>
                    </div>

                    <!-- Add URL Section -->
                    <div class="config-card p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-plus-circle text-blue-500 mr-2"></i>Crawl Website
                        </h3>
                        
                        <!-- Single Page Crawl -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Single Page</label>
                            <div class="flex gap-3">
                                <input 
                                    type="url" 
                                    id="websiteUrlInput" 
                                    placeholder="https://example.com/products/product-page" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                />
                                <button 
                                    onclick="crawlWebsiteUrl()" 
                                    class="px-6 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all font-medium">
                                    <i class="fas fa-spider mr-2"></i>Crawl Page
                                </button>
                            </div>
                        </div>

                        <!-- Full Website Crawl -->
                        <div class="border-t pt-4 mt-4">
                            <label class="text-sm font-medium text-gray-700 mb-2 block">Entire Website (All Pages & Subpages)</label>
                            <div class="flex gap-3 mb-3">
                                <input 
                                    type="url" 
                                    id="websiteFullUrlInput" 
                                    placeholder="https://example.com" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                />
                                <button 
                                    onclick="crawlEntireWebsite()" 
                                    class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all font-medium whitespace-nowrap">
                                    <i class="fas fa-globe mr-2"></i>Crawl All
                                </button>
                            </div>
                            
                            <!-- Advanced Options -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-gray-600 mb-1 block">Max Pages</label>
                                    <input 
                                        type="number" 
                                        id="maxPages" 
                                        value="100" 
                                        min="1" 
                                        max="500" 
                                        class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>
                                <div>
                                    <label class="text-xs text-gray-600 mb-1 block">Max Depth</label>
                                    <input 
                                        type="number" 
                                        id="maxDepth" 
                                        value="3" 
                                        min="1" 
                                        max="5" 
                                        class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:outline-none"
                                    />
                                </div>
                            </div>
                            
                            <div class="mt-2 flex items-start gap-2">
                                <input type="checkbox" id="useSitemap" checked class="mt-1">
                                <label for="useSitemap" class="text-xs text-gray-600">
                                    <i class="fas fa-sitemap mr-1"></i>Use sitemap.xml if available (faster)
                                </label>
                            </div>
                        </div>

                        <p class="text-sm text-gray-600 mt-3">
                            <i class="fas fa-info-circle mr-1"></i>
                            Crawl entire website to index all product pages, specs, and pricing automatically
                        </p>
                        
                        <!-- Progress Indicator -->
                        <div id="crawlProgress" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-900">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Crawling website...
                                </span>
                                <span id="crawlProgressCount" class="text-xs text-blue-700">0 pages</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div id="crawlProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Website Content Section -->
                    <div class="config-card p-6 rounded-xl shadow-lg mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-search text-purple-500 mr-2"></i>Test Search
                        </h3>
                        <div class="flex gap-3 mb-4">
                            <input 
                                type="text" 
                                id="websiteSearchQuery" 
                                placeholder="Search for product info, specs, pricing..." 
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                            />
                            <button 
                                onclick="searchWebsiteContent()" 
                                class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
                                <i class="fas fa-search mr-2"></i>Search
                            </button>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="websiteSearchResults" class="hidden mt-4">
                            <h4 class="font-semibold text-gray-700 mb-3">Search Results:</h4>
                            <div id="websiteSearchResultsList" class="space-y-3">
                                <!-- Results will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Crawled URLs List -->
                    <div class="config-card p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">
                                <i class="fas fa-list text-green-500 mr-2"></i>Crawled Content
                            </h3>
                            <button 
                                onclick="refreshWebsiteList()" 
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold">Page Title</th>
                                        <th class="px-4 py-3 text-left font-semibold">URL</th>
                                        <th class="px-4 py-3 text-left font-semibold">Type</th>
                                        <th class="px-4 py-3 text-left font-semibold">Chunks</th>
                                        <th class="px-4 py-3 text-left font-semibold">Crawled</th>
                                        <th class="px-4 py-3 text-left font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="websiteUrlsList">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Customer Detail Modal -->
    <div id="customerModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40" onclick="document.getElementById('customerModal').classList.add('hidden')"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg p-6 overflow-hidden">
            <header class="flex justify-between items-center mb-4">
                <div>
                    <h2 id="customerModalName" class="text-lg font-semibold">Customer</h2>
                    <div id="customerModalPhone" class="text-xs text-gray-500"></div>
                </div>
                <button id="closeCustomerModalBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="mb-4">
                <div class="mb-2"><strong>Last Order:</strong> <span id="customerModalLastOrder">N/A</span></div>
                <div class="mb-2"><strong>Total Spent:</strong> <span id="customerModalTotalSpent">0.00</span></div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Notes</h3>
                <ul id="customerNotesList" class="mb-2 space-y-2 max-h-40 overflow-y-auto">
                    <!-- Notes loaded dynamically -->
                </ul>
                <form id="addNoteForm" class="flex gap-2">
                    <input id="newNoteText" type="text" placeholder="Add a note..." class="flex-1 border rounded px-3 py-2" required />
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Add</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Visit Details Modal -->
    <div id="visitModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="modal-content relative w-full max-w-3xl bg-gradient-to-br from-gray-900 to-purple-900 rounded-2xl shadow-2xl overflow-hidden">
            <!-- Modal Header -->
            <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold">Visit Details</h2>
                        <div id="visitModalMeta" class="text-white/80 text-sm mt-1"></div>
                    </div>
                    <button onclick="document.getElementById('visitModal').classList.add('hidden')" class="ml-4 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Visit Content -->
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                <!-- Basic Info Grid -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Customer</div>
                        <div id="visitCustomer" class="text-white font-semibold text-lg">-</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Salesman</div>
                        <div id="visitSalesman" class="text-white font-semibold">-</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Branch</div>
                        <div id="visitBranch" class="text-white font-semibold">-</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Visit Type</div>
                        <div id="visitType" class="text-white font-semibold">-</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Date & Time</div>
                        <div id="visitDateTime" class="text-white font-semibold">-</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Duration</div>
                        <div id="visitDuration" class="text-white font-semibold">-</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Status</div>
                        <div id="visitStatus" class="text-white font-semibold">-</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Potential</div>
                        <div id="visitPotential" class="text-white font-semibold">-</div>
                    </div>
                </div>

                <!-- Location -->
                <div class="bg-white/10 rounded-lg p-4">
                    <div class="text-white/60 text-sm mb-2">Location</div>
                    <div id="visitLocation" class="text-white">-</div>
                </div>

                <!-- Notes -->
                <div class="bg-white/10 rounded-lg p-4">
                    <div class="text-white/60 text-sm mb-2">Notes</div>
                    <div id="visitNotes" class="text-white whitespace-pre-wrap">-</div>
                </div>

                <!-- Images -->
                <div id="visitImagesSection" class="hidden">
                    <div class="text-white/60 text-sm mb-3">Visit Images</div>
                    <div id="visitImages" class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <!-- Images loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Salesman Details Modal -->
    <div id="salesmanModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="modal-content relative w-full max-w-2xl bg-gradient-to-br from-gray-900 to-purple-900 rounded-2xl shadow-2xl overflow-hidden">
            <!-- Modal Header -->
            <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-tie text-2xl"></i>
                            </div>
                            <div>
                                <h2 id="salesmanModalName" class="text-2xl font-bold">Salesman Details</h2>
                                <div id="salesmanModalPhone" class="text-white/80 text-sm mt-1"></div>
                            </div>
                        </div>
                    </div>
                    <button onclick="document.getElementById('salesmanModal').classList.add('hidden')" class="ml-4 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Salesman Content -->
            <div class="p-6 space-y-6">
                <!-- Info Cards -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Branch</div>
                        <div id="salesmanBranch" class="text-white font-semibold">-</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <div class="text-white/60 text-sm mb-1">Status</div>
                        <div id="salesmanStatus" class="text-white font-semibold">-</div>
                    </div>
                </div>

                <!-- Visit Statistics -->
                <div class="bg-white/10 rounded-lg p-4">
                    <h3 class="text-white font-semibold mb-3 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-blue-400"></i>
                        Visit Statistics
                    </h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div id="salesmanTotalVisits" class="text-3xl font-bold text-blue-400">0</div>
                            <div class="text-white/60 text-sm mt-1">Total Visits</div>
                        </div>
                        <div class="text-center">
                            <div id="salesmanMonthVisits" class="text-3xl font-bold text-green-400">0</div>
                            <div class="text-white/60 text-sm mt-1">This Month</div>
                        </div>
                        <div class="text-center">
                            <div id="salesmanTodayVisits" class="text-3xl font-bold text-purple-400">0</div>
                            <div class="text-white/60 text-sm mt-1">Today</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Salesman Modal -->
    <div id="addEditSalesmanModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeSalesmanForm()">
        <div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="modal-content relative w-full max-w-2xl bg-gradient-to-br from-purple-600 to-blue-600 rounded-2xl shadow-2xl overflow-hidden animate-slide-up" onclick="event.stopPropagation()">
            <!-- Modal Header -->
            <header class="bg-gradient-to-r from-purple-700 to-blue-700 text-white p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-plus text-2xl" id="salesmanFormIcon"></i>
                            </div>
                            <div>
                                <h2 id="salesmanFormTitle" class="text-2xl font-bold">Add Salesman</h2>
                                <div class="text-white/80 text-sm mt-1">Complete all required fields</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeSalesmanForm()" class="ml-4 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Form Content -->
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                <form id="salesmanForm" class="space-y-4">
                    <input type="hidden" id="salesmanFormId" value="">
                    
                    <!-- Name -->
                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-user mr-2"></i>Full Name <span class="text-red-400">*</span>
                        </label>
                        <input type="text" id="salesmanFormName" required 
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40 focus:border-transparent"
                            placeholder="Enter salesman name">
                    </div>

                    <!-- Phone -->
                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-phone mr-2"></i>Phone Number <span class="text-red-400">*</span>
                        </label>
                        <input type="tel" id="salesmanFormPhone" required 
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40 focus:border-transparent"
                            placeholder="10-digit mobile number" pattern="[0-9]{10,15}">
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-envelope mr-2"></i>Email Address
                        </label>
                        <input type="email" id="salesmanFormEmail" 
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40 focus:border-transparent"
                            placeholder="email@example.com">
                    </div>

                    <!-- Plant/Branch Assignment (Multi-Select) -->
                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-building mr-2"></i>Assigned Branches <span class="text-red-400">*</span>
                        </label>
                        <div class="bg-white/10 border border-white/20 rounded-lg p-3 max-h-48 overflow-y-auto">
                            <div id="plantCheckboxes" class="space-y-2">
                                <div class="text-white/60 text-sm">Loading branches...</div>
                            </div>
                        </div>
                        <div class="text-white/60 text-xs mt-1">Select one or more branches for this salesman</div>
                    </div>

                    <!-- Status -->
                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-toggle-on mr-2"></i>Status
                        </label>
                        <select id="salesmanFormStatus" 
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/40 focus:border-transparent">
                            <option value="1" class="bg-purple-800">Active</option>
                            <option value="0" class="bg-purple-800">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>

            <!-- Form Actions -->
            <div class="p-6 bg-white/5 border-t border-white/10 flex justify-end space-x-3">
                <button type="button" onclick="closeSalesmanForm()" 
                    class="px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors font-medium">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" form="salesmanForm" id="salesmanFormSubmit"
                    class="px-6 py-3 bg-white hover:bg-white/90 text-purple-700 rounded-lg transition-colors font-bold shadow-lg">
                    <i class="fas fa-save mr-2"></i>Save Salesman
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Target Modal -->
    <div id="addEditTargetModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeTargetForm()">
        <div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="modal-content relative w-full max-w-2xl bg-gradient-to-br from-blue-600 to-indigo-600 rounded-2xl shadow-2xl overflow-hidden animate-slide-up" onclick="event.stopPropagation()">
            <header class="bg-gradient-to-r from-blue-700 to-indigo-700 text-white p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-bullseye text-2xl" id="targetFormIcon"></i>
                            </div>
                            <div>
                                <h2 id="targetFormTitle" class="text-2xl font-bold">Add Sales Target</h2>
                                <div class="text-white/80 text-sm mt-1">Set monthly targets for salesmen</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeTargetForm()" class="ml-4 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </header>

            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                <form id="targetForm" class="space-y-4">
                    <input type="hidden" id="targetFormId" value="">
                    
                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-user-tie mr-2"></i>Salesman <span class="text-red-400">*</span>
                        </label>
                        <select id="targetFormSalesman" required 
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/40">
                            <option value="" class="bg-blue-800">Select Salesman</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-calendar mr-2"></i>Target Month <span class="text-red-400">*</span>
                        </label>
                        <input type="month" id="targetFormPeriod" required 
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-white/40">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white/90 text-sm font-semibold mb-2">
                                <i class="fas fa-map-marker-alt mr-2"></i>Visit Target
                            </label>
                            <input type="number" id="targetFormVisits" min="0" placeholder="0"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm font-semibold mb-2">
                                <i class="fas fa-shopping-cart mr-2"></i>Order Target
                            </label>
                            <input type="number" id="targetFormOrders" min="0" placeholder="0"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40">
                        </div>
                    </div>

                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-rupee-sign mr-2"></i>Revenue Target ()
                        </label>
                        <input type="number" id="targetFormRevenue" min="0" step="0.01" placeholder="0.00"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40">
                    </div>

                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-user-plus mr-2"></i>New Customer Target
                        </label>
                        <input type="number" id="targetFormNewCustomers" min="0" placeholder="0"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40">
                    </div>
                </form>
            </div>

            <div class="p-6 bg-white/5 border-t border-white/10 flex justify-end space-x-3">
                <button type="button" onclick="closeTargetForm()" 
                    class="px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors font-medium">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" form="targetForm"
                    class="px-6 py-3 bg-white hover:bg-white/90 text-blue-700 rounded-lg transition-colors font-bold shadow-lg">
                    <i class="fas fa-save mr-2"></i>Save Target
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Branch Modal -->
    <div id="addEditBranchModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeBranchForm()">
        <div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="modal-content relative w-full max-w-2xl bg-gradient-to-br from-green-600 to-teal-600 rounded-2xl shadow-2xl overflow-hidden animate-slide-up" onclick="event.stopPropagation()">
            <header class="bg-gradient-to-r from-green-700 to-teal-700 text-white p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-building text-2xl" id="branchFormIcon"></i>
                            </div>
                            <div>
                                <h2 id="branchFormTitle" class="text-2xl font-bold">Add Branch</h2>
                                <div class="text-white/80 text-sm mt-1">Configure branch/plant details</div>
                            </div>
                        </div>
                    </div>
                    <button onclick="closeBranchForm()" class="ml-4 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </header>

            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                <form id="branchForm" class="space-y-4">
                    <input type="hidden" id="branchFormId" value="">
                    
                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-building mr-2"></i>Branch Name <span class="text-red-400">*</span>
                        </label>
                        <input type="text" id="branchFormName" required 
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40"
                            placeholder="Enter branch name">
                    </div>

                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-map-marker-alt mr-2"></i>Location/Address
                        </label>
                        <textarea id="branchFormLocation" rows="2"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40"
                            placeholder="Full address"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-white/90 text-sm font-semibold mb-2">
                                <i class="fas fa-city mr-2"></i>City
                            </label>
                            <input type="text" id="branchFormCity"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40"
                                placeholder="City name">
                        </div>
                        <div>
                            <label class="block text-white/90 text-sm font-semibold mb-2">
                                <i class="fas fa-flag mr-2"></i>State
                            </label>
                            <input type="text" id="branchFormState"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40"
                                placeholder="State name">
                        </div>
                    </div>

                    <div>
                        <label class="block text-white/90 text-sm font-semibold mb-2">
                            <i class="fas fa-globe mr-2"></i>Country
                        </label>
                        <input type="text" id="branchFormCountry" value="India"
                            class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/40">
                    </div>
                </form>
            </div>

            <div class="p-6 bg-white/5 border-t border-white/10 flex justify-end space-x-3">
                <button type="button" onclick="closeBranchForm()" 
                    class="px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors font-medium">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" form="branchForm"
                    class="px-6 py-3 bg-white hover:bg-white/90 text-green-700 rounded-lg transition-colors font-bold shadow-lg">
                    <i class="fas fa-save mr-2"></i>Save Branch
                </button>
            </div>
        </div>
    </div>

    <!-- Conversation Modal -->
    <!-- Conversation Details Modal -->
    <div id="conversationModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.classList.add('hidden')">
        <div class="modal-backdrop absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="modal-content relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden animate-slide-up">
            <!-- Modal Header -->
            <header class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <h2 id="convTitle" class="text-2xl font-bold">Conversation Details</h2>
                                <div id="convMeta" class="text-white/80 text-sm mt-1"></div>
                            </div>
                        </div>
                        <div id="convStats" class="flex gap-4 mt-4 text-sm">
                            <!-- Stats will be added dynamically -->
                        </div>
                    </div>
                    <button id="closeConvBtn" class="ml-4 w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </header>

            <!-- Messages Area -->
            <div class="p-6">
                <div id="convMessages" class="h-96 overflow-y-auto bg-gray-50 rounded-xl p-4 space-y-3 mb-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading messages...</p>
                    </div>
                </div>

                <!-- Reply Composer (inline, no browser popup) -->
                <div id="replyComposer" class="hidden bg-white border border-gray-200 rounded-xl p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium text-gray-700">Reply</div>
                        <button id="replyCancelBtn" type="button" class="text-sm text-gray-500 hover:text-gray-700">Cancel</button>
                    </div>
                    <textarea id="replyText" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your reply..."></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="replySendBtn" type="button" class="px-5 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-medium">
                            <i class="fas fa-paper-plane mr-2"></i>Send
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 justify-between items-center">
                    <button id="loadMoreBtn" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                        <i class="fas fa-history mr-2"></i>Load Older Messages
                    </button>
                    <div class="flex gap-3">
                        <button id="exportConvBtn" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors font-medium">
                            <i class="fas fa-download mr-2"></i>Export
                        </button>
                        <button id="replyBtn" class="hidden px-6 py-2.5 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all font-medium">
                            <i class="fas fa-reply mr-2"></i>Send Reply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative w-full max-w-4xl bg-white rounded-lg shadow-lg p-6 z-10 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-semibold">Order <span id="orderId">#Loading...</span></h3>
                    <p id="orderPlacedAt" class="text-sm text-gray-500">Placed:</p>
                </div>
                <div class="flex items-center gap-3">
                    <select id="orderStatusSelect" class="rounded border px-3 py-1 text-sm">
                        <!-- options inserted by JS -->
                    </select>
                    <button id="saveOrderStatusBtn" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">Save</button>
                    <button id="closeOrderModal" class="bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">Close</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                <div>
                    <div class="mb-2"><strong>Status:</strong> <span id="orderStatusLabel" class="text-sm">Loading...</span></div>
                    <div class="mb-2"><strong>Mobile Number:</strong> <span id="orderCustomerPhone" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Customer Name:</strong> <span id="orderCustomerName" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Zoho Invoice No.:</strong> <span id="orderZohoInvoiceNo" class="text-sm text-gray-700">Loading...</span></div>
                    <div class="mb-2"><strong>Shipping Address:</strong> <div id="orderShippingAddress" class="text-sm text-gray-600">Loading...</div></div>
                </div>

                <div class="md:col-span-2">
                    <div class="flex justify-end">
                        <div class="text-right space-y-1">
                            <div class="flex justify-between gap-4"><span>Subtotal:</span><span id="orderSubtotal">0.00</span></div>
                            <div class="flex justify-between gap-4"><span>Shipping:</span><span id="orderShipping">0.00</span></div>
                            <div class="flex justify-between gap-4"><span>GST:</span><span id="orderGST">0.00</span></div>
                            <div class="border-t pt-2 flex justify-between gap-4 font-semibold"><span>Total:</span><span id="orderTotal">0.00</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products table -->
            <div>
                <h4 class="font-medium mb-2">Products</h4>
                <div class="overflow-auto max-h-48">
                    <table class="w-full text-sm" id="orderItemsTable">
                        <thead class="text-left text-xs text-gray-600">
                            <tr>
                                <th class="pb-2">Product</th>
                                <th class="pb-2">SKU</th>
                                <th class="pb-2 text-right">Qty</th>
                                <th class="pb-2 text-right">Unit Price</th>
                                <th class="pb-2 text-right">Line Total</th>
                            </tr>
                        </thead>
                        <tbody id="orderItemsTableBody">
                            <!-- JS inserts rows here -->
                        </tbody>
                    </table>
                </div>
                <div id="noItemsNotice" class="text-sm text-gray-500 mt-2 hidden">Product details not available.</div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-backdrop absolute inset-0 bg-black opacity-40"></div>
        <div class="modal-content relative w-11/12 md:w-2/3 lg:w-1/2 bg-white rounded-lg shadow-lg p-6 overflow-auto max-h-[80vh]">
            <header class="flex justify-between items-center mb-4">
                <h2 id="editProdTitle" class="text-lg font-semibold">Edit Product</h2>
                <button id="closeEditProdBtn" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
            </header>
            <div class="space-y-3">
                <input type="hidden" id="editProdId" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input id="editProdName" class="w-full px-3 py-2 border rounded" />
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">SKU ID</label>
                        <input id="editProdSku" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input id="editProdDescription" class="w-full px-3 py-2 border rounded" />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                        <input id="editProdPrice" type="number" step="0.01" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
                        <input id="editProdStock" type="number" class="w-full px-3 py-2 border rounded" />
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
                        <input id="editProdBrand" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="editProdCategory" class="w-full px-3 py-2 border rounded"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Packaging Unit</label>
                        <input id="editProdPackagingUnit" class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Units per Carton</label>
                            <th class="text-left py-3 px-4">Salesman</th>
                            <th class="text-left py-3 px-4">Month</th>
                            <th class="text-left py-3 px-4">Visit Target</th>
                            <th class="text-left py-3 px-4">Achieved Visits</th>
                            <th class="text-left py-3 px-4">Order Target</th>
                            <th class="text-left py-3 px-4">Achieved Orders</th>
                            <th class="text-left py-3 px-4">Revenue Target</th>
                            <th class="text-left py-3 px-4">Achieved Revenue</th>
                            <th class="text-left py-3 px-4">Progress</th>
                        </tr>
                    </thead>
                    <tbody id="targetsTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-8 text-white/60">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading targets...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Branches Tab -->
    <div id="branchesTab" class="hidden">
        <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-white text-2xl font-bold">Branches & Plants</h2>
                <button onclick="showAddBranchModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-white">
                    <i class="fas fa-plus mr-2"></i>Add Branch
                </button>
            </div>

            <!-- Branches Table -->
            <div class="glass-effect rounded-xl p-6 overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-white/60 text-sm border-b border-white/10">
                            <th class="text-left py-3 px-4">Branch Name</th>
                            <th class="text-left py-3 px-4">Location</th>
                            <th class="text-left py-3 px-4">Contact</th>
                            <th class="text-left py-3 px-4">Assigned Salesmen</th>
                            <th class="text-left py-3 px-4">Status</th>
                            <th class="text-left py-3 px-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="branchesTableBody">
                        <tr>
                            <td colspan="6" class="text-center py-8 text-white/60">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading branches...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    // ---------- Category Loader ----------
    async function loadCategoriesDropdown() {
        try {
            const tenantId = state.session?.tenantId;
            const response = await fetch(`/api/categories?tenantId=${tenantId}`);
            const data = await response.json();
            const dropdown = document.getElementById('editProdCategory');
            if (!dropdown) return;
            dropdown.innerHTML = '';
            if (data.success && Array.isArray(data.categories) && data.categories.length > 0) {
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    dropdown.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No categories found';
                dropdown.appendChild(option);
            }
        } catch (err) {
            console.error('Failed to load categories:', err);
        }
    }

    document.getElementById('editProductModal')?.addEventListener('show', loadCategoriesDropdown);

    // ---------- Bulk Add Products ----------
    // These will be initialized after DOM is fully loaded
    function initBulkUploadHandlers() {
        const bulkAddBtn = document.getElementById('bulkAddProductsBtn');
        const uploadBtn = document.getElementById('uploadBulkProductsBtn');
        const modal = document.getElementById('bulkAddProductsModal');
        
        if (bulkAddBtn) {
            bulkAddBtn.addEventListener('click', function() {
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            });
        }

        if (uploadBtn) {
            uploadBtn.addEventListener('click', async function() {
                const fileInput = document.getElementById('bulkProductsFile');
                if (!fileInput || !fileInput.files.length) {
                    showNotification('Please select a file to upload.', 'warning');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('tenantId', state.session?.tenantId);
                
                try {
                    showNotification('Uploading products...', 'info');
                    const response = await fetch('/api/products/bulk-upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`Successfully uploaded ${result.count || 0} products!`, 'success');
                        if (modal) {
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                        }
                        fileInput.value = ''; // Clear file input
                        loadProducts(); // Reload products
                    } else {
                        showNotification(result.error || 'Upload failed.', 'error');
                    }
                } catch (err) {
                    console.error('Upload error:', err);
                    showNotification('Upload failed: ' + err.message, 'error');
                }
            });
        }
    }

    // ---------- Manage Categories Modal ----------
    function initManageCategoriesHandler() {
        const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
        const modal = document.getElementById('manageCategoriesModal');
        
        if (manageCategoriesBtn) {
            manageCategoriesBtn.addEventListener('click', function() {
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    loadCategories(); // Load categories when modal opens
                }
            });
        }
    }
    
    // ---------- Application State ----------
    const state = {
        session: null,
        currentTab: 'overview',
        data: { stats: null, conversations: [], orders: [], products: [], settings: {} },
        searchQuery: '',
        isLoading: false,
        fsmUser: null, // FSM user role and access level
        fsmVisits: {
            all: [],
            page: 1,
            pageSize: 10,
            sortKey: 'visit_date',
            sortDir: 'desc',
            columns: {
                date: true,
                customer: true,
                salesman: true,
                branch: true,
                type: true,
                duration: true,
                potential: true,
                status: true,
                actions: true
            }
        },
        fsmPlantsMap: {}
    };
    // ---------- API Helpers ----------
    const api = {
        authHeaders() {
            return state.session?.token ? { 'Authorization': `Bearer ${state.session.token}` } : {};
        },

        async verifyToken(token) {
            const response = await fetch('/api/verify-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            });
            return await response.json();
        },

        async fetchData(endpoint) {
            if (!state.session?.tenantId) throw new Error('No tenant session');
            const response = await fetch(`/api/dashboard/${endpoint}/${state.session.tenantId}`, {
                headers: { ...this.authHeaders() }
            });
            if (!response.ok) throw new Error(`Failed to fetch ${endpoint}`);
            return await response.json();
        },

        async updateSettings(settingsData) {
            const response = await fetch(`/api/dashboard/settings/${state.session.tenantId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                body: JSON.stringify(settingsData)
            });
            return await response.json();
        },

        async deleteItem(type, id) {
            const response = await fetch(`/api/dashboard/${type}/${state.session.tenantId}/${id}`, {
                method: 'DELETE',
                headers: { ...this.authHeaders() }
            });
            return await response.json();
        },

        async putJSON(path, payload) {
            const response = await fetch(path, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                body: JSON.stringify(payload)
            });
            return await response.json();
        },

        async postJSON(path, payload) {
            const response = await fetch(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                body: JSON.stringify(payload)
            });
            return await response.json();
        }
    };

    function isUuid(value) {
        return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(value || ''));
    }

    function formatPlantLabel(plantId) {
        if (!plantId) return '-';
        const key = String(plantId);
        if (state.fsmPlantsMap[key]) return state.fsmPlantsMap[key];
        if (key === 'Hylite Galvanisers Pimpri - HGP') return 'Hylite Galvanisers - Pimpri';
        if (isUuid(key)) return `Branch ${key.slice(0, 8)}`;
        return key;
    }

    // ---------- Utilities ----------
    function showNotification(message, type = 'info') {
        const colors = {
            success: 'success-alert',
            error: 'error-alert',
            info: 'bg-blue-500 text-white',
            warning: 'bg-orange-500 text-white'
        };
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[type]} px-6 py-3 rounded-xl shadow-lg z-50 animate-slide-up`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3500);
    }

    function escapeHtml(str) {
        if (typeof str !== 'string') return str;
        return str.replace(/[&<>"']/g, function (c) {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c];
        });
    }

    function fmtINR(value) {
        try {
            const num = Number(value || 0);
            if (isNaN(num)) return '0.00';
            return '' + num.toLocaleString('en-IN', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        } catch (error) {
            console.warn('Error formatting currency:', error);
            return '0.00';
        }
    }

    // ---------- Order Modal Functions ----------
    async function loadOrderAndShowModal(orderId, tenantId) {
        try {
            console.log('Loading order modal for:', orderId);
            const modal = document.getElementById('orderModal');
            if (!modal) {
                console.error('Order modal not found in DOM');
                showNotification('Error: Order modal not available', 'error');
                return;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            const orderIdElement = document.getElementById('orderId');
            if (orderIdElement) {
                orderIdElement.textContent = 'Loading...';
            }
            
            const response = await fetch(`/api/dashboard/orders/${encodeURIComponent(tenantId)}?limit=100&offset=0`);
            if (!response.ok) {
                throw new Error(`Failed to fetch orders: ${response.status}`);
            }
            
            const data = await response.json();
            if (!data.success || !data.orders) {
                throw new Error('Invalid response format');
            }
            
            let order = data.orders.find(o => String(o.id) === String(orderId));
            if (!order) {
                throw new Error('Order not found');
            }
            
            if (order.conversation_id && (!order.customerName || order.customerName === order.conversation?.end_user_phone)) {
                try {
                    const convResponse = await fetch(`/api/dashboard/conversation/${tenantId}/${order.conversation_id}`);
                    if (convResponse.ok) {
                        const convData = await convResponse.json();
                        if (convData.success && convData.conversation) {
                            const messages = convData.conversation.messages || [];
                            const customerMessages = messages.filter(m => m.sender === 'user' || m.sender === 'customer');
                            for (const msg of customerMessages.slice(0, 5)) {
                                const text = msg.message_body || '';
                                const nameMatch = text.match(/(?:my name is|i am|i'm)\s+([a-zA-Z\s]{2,20})/i);
                                if (nameMatch && nameMatch[1].trim().length > 1) {
                                    order.customerName = nameMatch[1].trim();
                                    break;
                                }
                            }
                        }
                    }
                } catch (convError) {
                    console.warn('Could not enhance customer name:', convError);
                }
            }
            
            renderOrderDetails(order);
            
        } catch (error) {
            console.error('Error loading order modal:', error);
            showNotification(`Failed to load order: ${error.message}`, 'error');
            
            const modal = document.getElementById('orderModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
    }

    function renderOrderDetails(order) {
        console.log('Rendering order details:', order);
        
        function safeSetText(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.warn(`Element not found: ${elementId}`);
            }
        }

        safeSetText('orderId', '#' + (order.id || '').substring(0, 8));
        safeSetText('orderPlacedAt', order.created_at ? 
            'Placed: ' + new Date(order.created_at).toLocaleString() : '');
        safeSetText('orderStatusLabel', order.order_status || 'N/A');
        
        let customerPhone = order.conversation?.end_user_phone || order.customer_phone || 'N/A';
        if (typeof customerPhone === 'string' && customerPhone.endsWith('@c.us')) {
            customerPhone = customerPhone.replace(/@c\.us$/, '');
        }
        // Always show the cleaned phone number under Mobile Number
        safeSetText('orderCustomerPhone', customerPhone);

        // Customer Name fallback to N/A if not present or same as phone
        const customerName = order.customerName && order.customerName !== customerPhone ? order.customerName : 'N/A';
        safeSetText('orderCustomerName', customerName);

        // Show Zoho Invoice No. if present, else N/A
        let zohoInvoiceNo = order.zoho_invoice_id || order.zoho_invoice_no || 'N/A';
        if (zohoInvoiceNo === null || zohoInvoiceNo === undefined || zohoInvoiceNo === '') zohoInvoiceNo = 'N/A';
        safeSetText('orderZohoInvoiceNo', zohoInvoiceNo);

        // Show shipping address if present, else N/A
        let shippingAddress = order.shippingAddress || order.shipping_address || '';
        if (!shippingAddress || shippingAddress.trim() === '') shippingAddress = 'N/A';
        safeSetText('orderShippingAddress', shippingAddress);
        
        const subtotal = Number(order.subtotal_amount || order.subtotal || 0);
        const shipping = Number(order.shipping_charges || order.shipping || 0);
        const gst = Number(order.gst_amount || order.gst || 0);
        const total = Number(order.total_amount || order.total || 0);
        
        safeSetText('orderSubtotal', fmtINR(subtotal));
        safeSetText('orderShipping', fmtINR(shipping));
        safeSetText('orderGST', fmtINR(gst));
        safeSetText('orderTotal', fmtINR(total));
        
        const tbody = document.getElementById('orderItemsTableBody');
        const noItemsNotice = document.getElementById('noItemsNotice');
        
        if (tbody) {
            tbody.innerHTML = '';
            const items = order.items || [];
            
            if (items.length === 0) {
                if (noItemsNotice) noItemsNotice.classList.remove('hidden');
            } else {
                if (noItemsNotice) noItemsNotice.classList.add('hidden');
                
                let totalCartons = 0;
                let totalPieces = 0;
                
                items.forEach(item => {
                    const quantity = Number(item.quantity || 0);
                    const unitsPerCarton = Number(item.unitsPerCarton || item.units_per_carton || 1000);
                    const pieces = quantity * unitsPerCarton;
                    totalCartons += quantity;
                    totalPieces += pieces;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="py-2">
                            <div class="font-medium">${escapeHtml(item.productName || item.product_name || 'Unknown Product')}</div>
                            <div class="text-xs text-gray-500">${pieces.toLocaleString()} pieces total</div>
                        </td>
                        <td class="py-2">${escapeHtml(item.sku || 'N/A')}</td>
                        <td class="py-2 text-right">
                            <div class="font-medium">${quantity} cartons</div>
                            <div class="text-xs text-gray-500">${unitsPerCarton.toLocaleString()}/carton</div>
                        </td>
                        <td class="py-2 text-right">${fmtINR(item.unitPrice || item.unit_price || item.price_at_time_of_purchase || 0)}</td>
                        <td class="py-2 text-right">${fmtINR(item.lineTotal || item.line_total || (quantity * (item.unitPrice || item.unit_price || 0)))}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'border-t-2 border-gray-300 bg-gray-50 font-semibold';
                summaryRow.innerHTML = `
                    <td class="py-3 font-bold">ORDER TOTALS</td>
                    <td class="py-3"></td>
                    <td class="py-3 text-right">
                        <div class="font-bold text-blue-600">${totalCartons} cartons</div>
                        <div class="text-sm text-blue-500">${totalPieces.toLocaleString()} pieces</div>
                    </td>
                    <td class="py-3"></td>
                    <td class="py-3 text-right font-bold text-lg">${fmtINR(total)}</td>
                `;
                tbody.appendChild(summaryRow);
            }
        }
        
        populateStatusDropdown(order.order_status || 'new');
        window.currentOrderId = order.id;
    }

    function populateStatusDropdown(currentStatus) {
        const statusSelect = document.getElementById('orderStatusSelect');
        if (!statusSelect) return;
        const statuses = [
            'new', 'pending_payment', 'pending', 'confirmed', 
            'shipped', 'delivered', 'cancelled', 'refunded'
        ];
        statusSelect.innerHTML = '';
        statuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            if (status === currentStatus) option.selected = true;
            statusSelect.appendChild(option);
        });
    }

    async function openConversation(tenantId, conversationId) {
        const modal = document.getElementById('conversationModal');
        const title = document.getElementById('convTitle');
        const meta = document.getElementById('convMeta');
        const stats = document.getElementById('convStats');
        const messagesEl = document.getElementById('convMessages');

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Show loading state
        messagesEl.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading conversation...</p>
            </div>
        `;
        title.textContent = 'Loading...';
        meta.textContent = '';
        stats.innerHTML = '';

        try {
            const resp = await fetch(`/api/dashboard/conversation/${tenantId}/${conversationId}`);
            const payload = await resp.json();
            
            if (!payload.success) {
                messagesEl.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-3"></i>
                        <p class="text-red-600 font-medium">Error loading conversation</p>
                        <p class="text-gray-500 text-sm mt-2">${escapeHtml(payload.error || 'Unknown error')}</p>
                    </div>
                `;
                return;
            }
            
            const { conversation } = payload;
            const messages = conversation.messages || [];
            
            // Update header info
            const phone = conversation.end_user_phone || 'Unknown';
            title.textContent = phone;
            meta.textContent = `ID: ${conversationId.substring(0, 8)}...  Updated: ${conversation.updated_at ? new Date(conversation.updated_at).toLocaleString() : 'Unknown'}`;

            // Keep context for Export / Reply actions
            window.currentConversationContext = {
                tenantId,
                conversationId,
                phone,
                messages
            };
            
            // Show stats
            stats.innerHTML = `
                <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                    <i class="fas fa-comments"></i>
                    <span>${messages.length} messages</span>
                </div>
                <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                    <i class="fas fa-info-circle"></i>
                    <span>State: ${escapeHtml(conversation.state || 'active')}</span>
                </div>
                ${conversation.last_product_discussed ? `
                    <div class="flex items-center space-x-2 bg-white/20 px-3 py-1.5 rounded-full">
                        <i class="fas fa-box"></i>
                        <span>${escapeHtml(conversation.last_product_discussed)}</span>
                    </div>
                ` : ''}
            `;

            // Render messages
            renderConversationMessages(messages, messagesEl);

            // Reset reply composer
            hideReplyComposer();
        } catch (error) {
            console.error('openConversation error', error);
            messagesEl.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-orange-500 text-3xl mb-3"></i>
                    <p class="text-gray-700 font-medium">Failed to load conversation</p>
                    <p class="text-gray-500 text-sm mt-2">${escapeHtml(error.message || String(error))}</p>
                </div>
            `;
        }
    }

    function renderConversationMessages(messages, messagesEl) {
        if (!messagesEl) return;
        const list = Array.isArray(messages) ? messages : [];

        function parseMessageDate(raw) {
            const s = String(raw || '').trim();
            if (!s) return new Date();
            // SQLite often returns "YYYY-MM-DD HH:MM:SS" (UTC). Treat as UTC for correct local display.
            if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(\.\d+)?$/.test(s)) {
                return new Date(s.replace(' ', 'T') + 'Z');
            }
            // ISO strings (with or without Z) are handled by Date.
            const d = new Date(s);
            return isNaN(d.getTime()) ? new Date() : d;
        }

        if (list.length === 0) {
            messagesEl.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                    <p class="text-gray-500">No messages in this conversation yet</p>
                </div>
            `;
            return;
        }

        messagesEl.innerHTML = '';
        list.forEach((m, index) => {
            const senderVal = String(m.sender || '').toLowerCase();
            const isCustomer = senderVal === 'user' || senderVal === 'customer' || /@c\.us$/.test(senderVal) || /^\+?\d+$/.test(senderVal);
            const prevMessage = list[index - 1];
            const createdAt = m.created_at || new Date().toISOString();
            const prevCreatedAt = prevMessage?.created_at || createdAt;

            const createdDate = parseMessageDate(createdAt);
            const prevDate = parseMessageDate(prevCreatedAt);

            const showDate = !prevMessage || createdDate.toDateString() !== prevDate.toDateString();

            if (showDate) {
                const dateDiv = document.createElement('div');
                dateDiv.className = 'text-center my-4';
                dateDiv.innerHTML = `
                    <span class="bg-gray-200 text-gray-600 text-xs px-3 py-1 rounded-full">
                        ${createdDate.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
                    </span>
                `;
                messagesEl.appendChild(dateDiv);
            }

            const bubble = document.createElement('div');
            bubble.className = `flex ${isCustomer ? 'justify-start' : 'justify-end'}`;

            const time = createdDate.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            bubble.innerHTML = `
                <div class="max-w-[75%] ${isCustomer ? 'bg-white' : 'bg-gradient-to-r from-blue-500 to-purple-600'} rounded-2xl shadow-sm">
                    <div class="px-4 py-3">
                        ${!isCustomer ? '' : `<div class="text-xs font-semibold text-blue-600 mb-1">Customer</div>`}
                        <div class="text-sm ${isCustomer ? 'text-gray-800' : 'text-white'} break-words whitespace-pre-wrap">${escapeHtml(m.message_body || '')}</div>
                        <div class="text-xs ${isCustomer ? 'text-gray-400' : 'text-white/70'} mt-1 flex items-center justify-end space-x-1">
                            <span>${time}</span>
                            ${!isCustomer ? '<i class="fas fa-check-double text-blue-200"></i>' : ''}
                        </div>
                    </div>
                </div>
            `;
            messagesEl.appendChild(bubble);
        });

        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function exportCurrentConversation() {
        const ctx = window.currentConversationContext;
        if (!ctx?.conversationId) {
            alert('No conversation loaded');
            return;
        }

        const safePhone = String(ctx.phone || 'unknown').replace(/[^0-9a-zA-Z_\-+]/g, '_');
        const filename = `conversation_${safePhone}_${String(ctx.conversationId).substring(0, 8)}.csv`;

        const rows = [['created_at', 'sender', 'message_body']];
        (ctx.messages || []).forEach(m => {
            rows.push([
                m.created_at || '',
                m.sender || '',
                (m.message_body || '').replace(/\r?\n/g, '\\n')
            ]);
        });

        const csv = '\ufeff' + rows
            .map(cols => cols.map(v => {
                const s = String(v ?? '');
                return '"' + s.replace(/"/g, '""') + '"';
            }).join(','))
            .join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    async function sendReplyFromConversation() {
        // Toggle the inline composer UI instead of showing a browser popup
        const ctx = window.currentConversationContext;
        if (!ctx?.tenantId || !ctx?.conversationId) {
            showNotification('No conversation loaded', 'warning');
            return;
        }
        showReplyComposer();
    }

    function showReplyComposer() {
        const composer = document.getElementById('replyComposer');
        const input = document.getElementById('replyText');
        if (!composer || !input) return;
        composer.classList.remove('hidden');
        input.focus();
    }

    function hideReplyComposer() {
        const composer = document.getElementById('replyComposer');
        const input = document.getElementById('replyText');
        const sendBtn = document.getElementById('replySendBtn');
        if (composer) composer.classList.add('hidden');
        if (input) input.value = '';
        if (sendBtn) sendBtn.disabled = false;
    }

    async function submitReplyFromComposer() {
        const ctx = window.currentConversationContext;
        if (!ctx?.tenantId || !ctx?.conversationId) {
            showNotification('No conversation loaded', 'warning');
            return;
        }

        const input = document.getElementById('replyText');
        const sendBtn = document.getElementById('replySendBtn');
        const messagesEl = document.getElementById('convMessages');
        const text = String(input?.value || '').trim();

        if (!text) return;
        if (sendBtn) sendBtn.disabled = true;

        // Optimistic UI append (so user sees it immediately)
        const optimistic = {
            id: `dashboard_${Date.now()}`,
            sender: 'bot',
            message_body: text,
            message_type: 'dashboard_reply',
            created_at: new Date().toISOString()
        };
        ctx.messages = Array.isArray(ctx.messages) ? ctx.messages : [];
        ctx.messages = [...ctx.messages, optimistic];
        window.currentConversationContext = { ...ctx };
        renderConversationMessages(ctx.messages, messagesEl);

        try {
            const resp = await fetch(`/api/dashboard/conversation/${encodeURIComponent(ctx.tenantId)}/${encodeURIComponent(ctx.conversationId)}/reply`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': state.session?.token ? `Bearer ${state.session.token}` : ''
                },
                body: JSON.stringify({ text })
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data?.success) {
                throw new Error(data?.error || 'Failed to send reply');
            }

            showNotification(data?.warning ? 'Reply sent (not logged)' : 'Reply sent', data?.warning ? 'warning' : 'success');
            hideReplyComposer();

            // Refresh only when backend logged successfully; otherwise keep optimistic message visible.
            if (!data?.warning) {
                await openConversation(ctx.tenantId, ctx.conversationId);
            }
        } catch (err) {
            console.error('[submitReplyFromComposer] error', err);
            showNotification(err?.message || 'Failed to send reply', 'error');
            if (sendBtn) sendBtn.disabled = false;
        }
    }

    // Open chat history from Follow-ups / Leads by phone number
    async function openChatFromPhone(phone) {
        try {
            const tenantId = state.session?.tenantId;
            if (!tenantId) {
                showNotification('Session expired. Re-login required.', 'error');
                return;
            }
            const p = String(phone || '').trim();
            if (!p) {
                showNotification('Missing phone number', 'warning');
                return;
            }

            const resp = await fetch(`/api/followups/${tenantId}/conversation-by-phone?phone=${encodeURIComponent(p)}`, {
                headers: { 'Authorization': `Bearer ${state.session.token}` }
            });
            const data = await resp.json();
            if (!data?.success || !data?.conversationId) {
                throw new Error(data?.error || 'Failed to open chat');
            }

            await openConversation(tenantId, data.conversationId);
        } catch (err) {
            console.error('[openChatFromPhone] error', err);
            showNotification(err?.message || 'Failed to open chat history', 'error');
        }
    }
    // ---------- UI Components ----------
    const components = {
        statsCard(icon, title, value, change, color) {
            return `
                <div class="stat-card card-hover p-6 rounded-2xl animate-slide-up">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r ${color} rounded-xl flex items-center justify-center">
                            <i class="${icon} text-white text-xl"></i>
                        </div>
                        ${change ? `<span class="text-green-400 text-sm font-medium">+${change}%</span>` : ''}
                    </div>
                    <h3 class="text-white/70 text-sm font-medium mb-1">${title}</h3>
                    <p class="text-white text-3xl font-bold">${value}</p>
                </div>
            `;
        },

        conversationCard(conv) {
            const lastMessage = conv.lastMessage || 'No messages yet';
            const messagePreview = lastMessage.length > 80 ? lastMessage.substring(0, 80) + '...' : lastMessage;
            return `
                <div class="conversation-card p-6 rounded-2xl mb-4 border border-white/20">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">${escapeHtml(conv.end_user_phone || 'Unknown')}</h4>
                                <p class="text-sm text-gray-500">State: ${escapeHtml(conv.state || 'Active')}</p>
                                ${conv.last_product_discussed ? `<p class="text-xs text-blue-600">Product: ${escapeHtml(conv.last_product_discussed)}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">${conv.updated_at ? new Date(conv.updated_at).toLocaleDateString() : ''}</span>
                            <button onclick="deleteConversation('${conv.id}')" class="delete-btn w-8 h-8 rounded-full bg-red-100 hover:bg-red-500 text-red-600 hover:text-white flex items-center justify-center">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl mb-4">
                        <p class="text-gray-700 text-sm">${escapeHtml(messagePreview)}</p>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-2">
                            <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full">${conv.messageCount || 0} messages</span>
                            ${conv.state === 'waiting' ? '<span class="px-3 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Needs follow-up</span>' : ''}
                        </div>
                        <button class="view-details-btn px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-sm rounded-xl" 
                                data-tenant-id="${state.session?.tenantId || ''}" data-conv-id="${conv.id}">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        },

        orderCard(order) {
            return `
                <div class="order-card conversation-card p-6 rounded-2xl mb-4 border border-white/20" data-order-id="${escapeHtml(order.id)}">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-600 rounded-xl flex items-center justify-center">
                                <i class="fas fa-shopping-bag text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900">Order #${escapeHtml(String(order.id).substring(0, 8))}...</h4>
                                <p class="text-sm text-gray-500">${escapeHtml(order.customerName || order.conversation?.end_user_phone || 'N/A')}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-900">${Number(order.total || 0).toFixed(2)}</p>
                            <p class="text-sm text-gray-500">${order.created_at ? new Date(order.created_at).toLocaleDateString() : ''}</p>
                        </div>
                    </div>

                    ${order.discount > 0 ? `
                        <div class="bg-green-50 p-3 rounded-xl mb-4">
                            <p class="text-green-800 text-sm"><i class="fas fa-tag mr-2"></i>Discount Applied: ${Number(order.discount).toFixed(2)} saved!</p>
                        </div>
                    ` : ''}

                    ${order.shipping ? `
                        <div class="grid grid-cols-2 gap-2 mb-4 text-xs">
                            <div class="bg-blue-50 p-2 rounded"><span class="text-blue-600">Shipping: ${Number(order.shipping).toFixed(2)}</span></div>
                            <div class="bg-purple-50 p-2 rounded"><span class="text-purple-600">GST: ${Number(order.gst || 0).toFixed(2)}</span></div>
                        </div>
                    ` : ''}

                    <div class="flex items-center justify-between space-x-3">
                        <span class="px-4 py-2 bg-green-100 text-green-800 text-sm rounded-xl font-medium">${escapeHtml(order.order_status || 'Confirmed')}</span>
                        <div class="flex space-x-2">
                            <button 
                              class="view-order-btn bg-blue-500 text-white px-3 py-1 rounded" 
                              data-order-id="${escapeHtml(order.id)}" 
                              data-tenant-id="${escapeHtml(state.session?.tenantId || '')}">
                              View Details
                            </button>
                            <button onclick="deleteOrder('${order.id}')" class="delete-btn w-10 h-10 rounded-xl bg-red-100 hover:bg-red-500 text-red-600 hover:text-white flex items-center justify-center">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    };

    // ---------- Tab & Load Management ----------
    function switchTab(tabName) {
        state.currentTab = tabName;
        
        // Update sidebar items
        document.querySelectorAll('.sidebar-item').forEach(item => {
            if (item.dataset.tab === tabName) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
        
        // Close sidebar on mobile after selection
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('mobile-open');
        }
        
        return loadTabContent(tabName);
    }
    
    // Toggle sidebar collapse/expand
    const SIDEBAR_STORAGE_KEY = 'salesmate_sidebar_collapsed_v1';

    function setSidebarCollapsed(isCollapsed) {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleBtn = document.getElementById('sidebarToggle');
        const icon = document.getElementById('sidebarToggleIcon') || toggleBtn?.querySelector('i');

        if (!sidebar || !mainContent || !toggleBtn) return;

        sidebar.classList.toggle('collapsed', isCollapsed);
        mainContent.classList.toggle('expanded', isCollapsed);
        toggleBtn.classList.toggle('collapsed', isCollapsed);

        if (icon) {
            icon.classList.remove('fa-bars', 'fa-angles-left', 'fa-angles-right');
            icon.classList.add(isCollapsed ? 'fa-angles-right' : 'fa-angles-left');
        }
    }

    function initSidebarUI() {
        // Add a tooltip to each nav item so icon-only mode is usable.
        document.querySelectorAll('.sidebar-item').forEach((item) => {
            if (!item.getAttribute('title')) {
                const label = item.querySelector('span')?.textContent?.trim();
                if (label) item.setAttribute('title', label);
            }
        });

        // Apply persisted collapse state on desktop.
        try {
            const saved = localStorage.getItem(SIDEBAR_STORAGE_KEY);
            if (window.innerWidth > 768) setSidebarCollapsed(saved === '1');
            else setSidebarCollapsed(false);
        } catch (_) {
            // If storage is blocked, just default to expanded.
            setSidebarCollapsed(false);
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar) return;
        
        // On mobile, toggle sidebar visibility
        if (window.innerWidth <= 768) {
            sidebar.classList.toggle('mobile-open');
        } else {
            // On desktop, toggle collapse
            const nextCollapsed = !sidebar.classList.contains('collapsed');
            setSidebarCollapsed(nextCollapsed);
            try { localStorage.setItem(SIDEBAR_STORAGE_KEY, nextCollapsed ? '1' : '0'); } catch (_) {}
        }
    }

    async function loadTabContent(tabName) {
        const content = document.getElementById('tabContent');
        const customersTab = document.getElementById('customersTab');
        const websiteTab = document.getElementById('websiteTab');
        const statsSection = document.getElementById('statsSection');
        
        // Clear any auto-refresh intervals when switching tabs
        if (window.broadcastHistoryInterval && tabName !== 'broadcast') {
            clearInterval(window.broadcastHistoryInterval);
            window.broadcastHistoryInterval = null;
        }
        if (window.waWebStatusInterval && tabName !== 'whatsapp-web') {
            clearInterval(window.waWebStatusInterval);
            window.waWebStatusInterval = null;
        }
        
        // Show stats section only on overview/dashboard tab
        if (statsSection) {
            if (tabName === 'overview') {
                statsSection.classList.remove('hidden');
            } else {
                statsSection.classList.add('hidden');
            }
        }
        
        // Hide all tab content first
        content.classList.remove('hidden');
        if (customersTab) customersTab.classList.add('hidden');
        if (websiteTab) websiteTab.classList.add('hidden');
        
        // Hide FSM tabs
        const visitsTab = document.getElementById('visitsTab');
        const salesmenTab = document.getElementById('salesmenTab');
        const targetsTab = document.getElementById('targetsTab');
        const branchesTab = document.getElementById('branchesTab');
        